---
- name: üéØ Deploy Monitoring Stack (Fixed)
  hosts: localhost
  connection: local
  become: yes
  gather_facts: yes

  vars:
    # –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¥–æ—Å—Ç—É–ø–Ω—É—é –≤–µ—Ä—Å–∏—é ClickHouse
    clickhouse_version: "22.3"  # –∏–ª–∏ –¥—Ä—É–≥–∞—è –¥–æ—Å—Ç—É–ø–Ω–∞—è –≤–µ—Ä—Å–∏—è
    clickhouse_port: 8123
    lighthouse_port: 8080

  pre_tasks:
    - name: üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –≤–µ—Ä—Å–∏–π ClickHouse
      apt:
        update_cache: yes
      tags: [setup]

    - name: üìã –ü–æ–∏—Å–∫ –≤–µ—Ä—Å–∏–π ClickHouse
      shell: |
        apt-cache search clickhouse-server | grep -o "clickhouse-server=[0-9.]*" | head -1 | cut -d'=' -f2 || echo "22.3"
      register: available_version
      changed_when: false
      tags: [setup]

  tasks:
    - name: üóÑÔ∏è –£—Å—Ç–∞–Ω–æ–≤–∫–∞ ClickHouse (–ø—Ä—è–º–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞)
      apt:
        name:
          - clickhouse-server
          - clickhouse-client
        state: present
        # –ù–µ —É–∫–∞–∑—ã–≤–∞–µ–º –≤–µ—Ä—Å–∏—é - —É—Å—Ç–∞–Ω–æ–≤–∏—Ç –¥–æ—Å—Ç—É–ø–Ω—É—é
      register: install_clickhouse
      tags: [clickhouse]

    - name: ‚è≥ –ó–∞–ø—É—Å–∫ –∏ –≤–∫–ª—é—á–µ–Ω–∏–µ ClickHouse
      systemd:
        name: clickhouse-server
        state: started
        enabled: yes
        daemon_reload: yes
      when: install_clickhouse.changed
      tags: [clickhouse]

    - name: üïê –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ ClickHouse
      wait_for:
        port: "{{ clickhouse_port }}"
        delay: 5
        timeout: 60
      tags: [dependencies]

    - name: üìä –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Vector (—á–µ—Ä–µ–∑ —Ä–æ–ª—å)
      include_role:
        name: vector
      vars:
        vector_version: "0.28.0"
      tags: [vector]

    - name: üéØ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Lighthouse (—á–µ—Ä–µ–∑ —Ä–æ–ª—å)
      include_role:
        name: lighthouse
      vars:
        lighthouse_version: "v4.0.1"
      tags: [lighthouse]

    - name: üåê –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤–µ–±-–¥–æ—Å—Ç—É–ø–∞
      block:
        - name: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ nginx
          apt:
            name: nginx
            state: present

        - name: –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è nginx
          copy:
            dest: /etc/nginx/sites-available/lighthouse
            content: |
              server {
                  listen 80;
                  server_name _;
                  location / {
                      proxy_pass http://127.0.0.1:{{ lighthouse_port }};
                      proxy_set_header Host $host;
                  }
              }

        - name: –ê–∫—Ç–∏–≤–∞—Ü–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
          file:
            src: /etc/nginx/sites-available/lighthouse
            dest: /etc/nginx/sites-enabled/lighthouse
            state: link

        - name: –£–¥–∞–ª–µ–Ω–∏–µ –¥–µ—Ñ–æ–ª—Ç–Ω–æ–≥–æ —Å–∞–π—Ç–∞
          file:
            path: /etc/nginx/sites-enabled/default
            state: absent

        - name: –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ nginx
          systemd:
            name: nginx
            state: restarted
      tags: [web]

  post_tasks:
    - name: ‚úÖ –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
      block:
        - name: –ü—Ä–æ–≤–µ—Ä–∫–∞ ClickHouse
          shell: |
            curl -s http://127.0.0.1:8123/ping 2>/dev/null || echo "NOT_FOUND"
          register: clickhouse_check
          changed_when: false

        - name: –ü—Ä–æ–≤–µ—Ä–∫–∞ Lighthouse
          shell: |
            curl -s -o /dev/null -w "%{http_code}" http://localhost:{{ lighthouse_port }}/ 2>/dev/null || echo "000"
          register: lighthouse_check
          changed_when: false

        - name: –û—Ç—á—ë—Ç
          debug:
            msg: |
              –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏—è:
              - ClickHouse: {{ '‚úì' if clickhouse_check.stdout == 'Ok.' else '‚úó' }}
              - Lighthouse: {{ '‚úì' if lighthouse_check.stdout == "200" else '‚úó' }}
              - –í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å: http://localhost:{{ lighthouse_port }}
              - ClickHouse UI: http://localhost:8123
      tags: [report]
