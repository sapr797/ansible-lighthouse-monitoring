---
- name: üöÄ Simple Lighthouse Deployment
  hosts: localhost
  connection: local
  become: yes

  vars:
    lighthouse_port: 8080

  tasks:
    # 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ ClickHouse
    - name: –ü—Ä–æ–≤–µ—Ä–∫–∞ ClickHouse
      shell: curl -s http://127.0.0.1:8123/ping
      register: clickhouse_status
      changed_when: false
      failed_when: clickhouse_status.stdout != "Ok."

    # 2. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Lighthouse (–ø—Ä—è–º–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞, –±–µ–∑ —Ä–æ–ª–∏)
    - name: –°–∫–∞—á–∏–≤–∞–Ω–∏–µ Lighthouse
      get_url:
        url: "https://github.com/sigp/lighthouse/releases/download/v4.0.1/lighthouse-v4.0.1-x86_64-unknown-linux-gnu.tar.gz"
        dest: "/tmp/lighthouse.tar.gz"

    - name: –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
      file:
        path: /opt/lighthouse
        state: directory

    - name: –†–∞—Å–ø–∞–∫–æ–≤–∫–∞
      unarchive:
        src: /tmp/lighthouse.tar.gz
        dest: /opt/lighthouse
        remote_src: yes

    - name: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏—Å–ø–æ–ª–Ω—è–µ–º–æ–≥–æ —Ñ–∞–π–ª–∞
      file:
        path: /opt/lighthouse/lighthouse
        mode: '0755'

    # 3. –ü—Ä–æ—Å—Ç–æ–π –≤–µ–±-—Å–µ—Ä–≤–µ—Ä –¥–ª—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
    - name: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Python HTTP —Å–µ—Ä–≤–µ—Ä–∞
      copy:
        dest: /opt/lighthouse/webserver.py
        content: |
          import http.server
          import socketserver
          import os
          
          PORT = {{ lighthouse_port }}
          DIRECTORY = "/opt/lighthouse"
          
          class Handler(http.server.SimpleHTTPRequestHandler):
              def __init__(self, *args, **kwargs):
                  super().__init__(*args, directory=DIRECTORY, **kwargs)
              
              def do_GET(self):
                  if self.path == '/health':
                      self.send_response(200)
                      self.send_header('Content-type', 'application/json')
                      self.end_headers()
                      self.wfile.write(b'{"status": "ok", "service": "lighthouse"}')
                  else:
                      super().do_GET()
          
          print(f"Lighthouse web server on port {PORT}")
          with socketserver.TCPServer(("", PORT), Handler) as httpd:
              httpd.serve_forever()

    - name: –°–æ–∑–¥–∞–Ω–∏–µ systemd —Å–ª—É–∂–±—ã
      copy:
        dest: /etc/systemd/system/lighthouse.service
        content: |
          [Unit]
          Description=Lighthouse Monitoring
          After=network.target
          
          [Service]
          Type=simple
          User=root
          WorkingDirectory=/opt/lighthouse
          ExecStart=/usr/bin/python3 /opt/lighthouse/webserver.py
          Restart=always
          
          [Install]
          WantedBy=multi-user.target

    - name: –ó–∞–ø—É—Å–∫ Lighthouse
      systemd:
        name: lighthouse
        state: started
        enabled: yes
        daemon_reload: yes

    - name: –ü—Ä–æ–≤–µ—Ä–∫–∞
      debug:
        msg: |
          Lighthouse —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏ –∑–∞–ø—É—â–µ–Ω!
          - –í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å: http://localhost:{{ lighthouse_port }}
          - Health check: http://localhost:{{ lighthouse_port }}/health
          - ClickHouse: http://localhost:8123 (—É–∂–µ —Ä–∞–±–æ—Ç–∞–µ—Ç)
