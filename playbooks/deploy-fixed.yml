---
- name: üöÄ Deploy Monitoring Stack (Fixed for ClickHouse 25.12 and Vector)
  hosts: localhost
  connection: local
  become: yes

  vars:
    clickhouse_port: 8123
    lighthouse_port: 8080
    vector_version: "0.28.0"

  tasks:
    # 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ ClickHouse (—É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω)
    - name: üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã ClickHouse
      shell: |
        curl -s http://127.0.0.1:8123/ping
      register: clickhouse_check
      changed_when: false
      failed_when: clickhouse_check.stdout != "Ok."
      tags: [clickhouse, validation]

    # 2. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Vector (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è)
    - name: üìä –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Vector –∏–∑ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–≥–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
      block:
        - name: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ GPG –∫–ª—é—á–∞ Vector
          apt_key:
            url: "https://apt.datadoghq.com/DATADOG_APT_KEY_CURRENT.public"
            state: present
          when: ansible_os_family == "Debian"

        - name: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è Vector
          apt_repository:
            repo: "deb https://apt.datadoghq.com/ stable 7"
            state: present
            filename: "datadog"
          when: ansible_os_family == "Debian"

        - name: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Vector
          apt:
            name: "datadog-agent={{ vector_version }}"
            state: present
            update_cache: yes
          when: ansible_os_family == "Debian"
      tags: [vector]

    # –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Vector —á–µ—Ä–µ–∑ .deb –ø–∞–∫–µ—Ç
    - name: üì¶ –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ Vector (—á–µ—Ä–µ–∑ .deb)
      block:
        - name: –°–∫–∞—á–∏–≤–∞–Ω–∏–µ .deb –ø–∞–∫–µ—Ç–∞ Vector
          get_url:
            url: "https://packages.timber.io/vector/{{ vector_version }}/vector-{{ vector_version }}-amd64.deb"
            dest: "/tmp/vector-{{ vector_version }}.deb"
            mode: '0644'

        - name: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ .deb –ø–∞–∫–µ—Ç–∞
          apt:
            deb: "/tmp/vector-{{ vector_version }}.deb"
            state: present
      when: false  # –ü–æ–º–µ–Ω—è–π—Ç–µ –Ω–∞ true –µ—Å–ª–∏ –Ω—É–∂–µ–Ω —ç—Ç–æ—Ç —Å–ø–æ—Å–æ–±
      tags: [vector]

    # 3. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Lighthouse —á–µ—Ä–µ–∑ —Ä–æ–ª—å
    - name: üéØ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Lighthouse
      include_role:
        name: lighthouse
      vars:
        lighthouse_version: "v4.0.1"
      tags: [lighthouse]

    # 4. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
    - name: üåê –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Nginx –¥–ª—è Lighthouse
      block:
        - name: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ nginx
          apt:
            name: nginx
            state: present

        - name: –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø—Ä–æ–∫—Å–∏
          copy:
            dest: /etc/nginx/sites-available/lighthouse
            content: |
              server {
                  listen 80;
                  server_name _;
                  
                  # –û—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å Lighthouse
                  location / {
                      proxy_pass http://127.0.0.1:{{ lighthouse_port }};
                      proxy_set_header Host $host;
                      proxy_set_header X-Real-IP $remote_addr;
                  }
                  
                  # Health check
                  location /health {
                      add_header Content-Type application/json;
                      return 200 '{"status": "ok", "services": ["clickhouse", "lighthouse"]}';
                  }
              }

        - name: –ê–∫—Ç–∏–≤–∞—Ü–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
          file:
            src: /etc/nginx/sites-available/lighthouse
            dest: /etc/nginx/sites-enabled/lighthouse
            state: link

        - name: –û—Ç–∫–ª—é—á–µ–Ω–∏–µ –¥–µ—Ñ–æ–ª—Ç–Ω–æ–≥–æ —Å–∞–π—Ç–∞
          file:
            path: /etc/nginx/sites-enabled/default
            state: absent

        - name: –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ nginx
          systemd:
            name: nginx
            state: restarted
      tags: [web, nginx]

    # 5. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    - name: ‚úÖ –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
      block:
        - name: –ü—Ä–æ–≤–µ—Ä–∫–∞ ClickHouse
          shell: |
            timeout 5 curl -s http://127.0.0.1:8123/ping || echo "ERROR"
          register: chk_clickhouse
          changed_when: false

        - name: –ü—Ä–æ–≤–µ—Ä–∫–∞ Vector
          shell: |
            which vector && vector --version || echo "VECTOR_NOT_FOUND"
          register: chk_vector
          changed_when: false

        - name: –ü—Ä–æ–≤–µ—Ä–∫–∞ Lighthouse
          shell: |
            timeout 5 curl -s -o /dev/null -w "%{http_code}" http://localhost:{{ lighthouse_port }}/ || echo "000"
          register: chk_lighthouse
          changed_when: false

        - name: –û—Ç—á—ë—Ç –æ —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–∏
          debug:
            msg: |
              üéâ –†–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!
              
              –°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–æ–≤:
              - ClickHouse {{ '‚úì' if 'Ok.' in chk_clickhouse.stdout else '‚úó' }} (v25.12.1)
              - Vector {{ '‚úì' if 'VECTOR_NOT_FOUND' not in chk_vector.stdout else '‚úó' }}
              - Lighthouse {{ '‚úì' if chk_lighthouse.stdout == "200" else '‚úó' }}
              
              –î–æ—Å—Ç—É–ø–Ω—ã–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã:
              {{ '- ClickHouse UI: http://localhost:8123' if 'Ok.' in chk_clickhouse.stdout else '' }}
              {{ '- Lighthouse: http://localhost:' ~ lighthouse_port if chk_lighthouse.stdout == "200" else '' }}
              {{ '- –í–µ–±-–ø—Ä–æ–∫—Å–∏: http://localhost/' if chk_lighthouse.stdout == "200" else '' }}
              
              –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:
              1. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ ClickHouse –±–∞–∑—É –¥–ª—è Lighthouse
              2. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä—É–π—Ç–µ Vector –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –ª–æ–≥–æ–≤ –≤ ClickHouse
              3. –î–æ–±–∞–≤—å—Ç–µ —Å–∞–π—Ç—ã –¥–ª—è –∞—É–¥–∏—Ç–∞
      tags: [report, validation]
