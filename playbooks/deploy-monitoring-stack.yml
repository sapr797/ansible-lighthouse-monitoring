---
- name: üéØ Deploy Complete Monitoring Stack
  hosts: localhost
  connection: local
  become: yes
  gather_facts: yes

  vars:
    clickhouse_host: "clickhous"
    clickhouse_port: 8123
    lighthouse_port: 8080
    web_port: 9090
    audit_sites:
      - "https://voronezh.poryadok.ru"
      - "https://krasnodar.poryadok.ru"
      - "https://poryadok.ru"

  pre_tasks:
    - name: üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π
      assert:
        that:
          - ansible_os_family == "Debian"
        fail_msg: "–¢—Ä–µ–±—É–µ—Ç—Å—è Ubuntu/Debian —Å–∏—Å—Ç–µ–º–∞"
      tags: [validation]

    - name: üì¶ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ apt –∫—ç—à–∞
      apt:
        update_cache: yes
        cache_valid_time: 3600
      tags: [setup]

  roles:
    - role: clickhouse
      clickhouse_version: "22.8"
      clickhouse_users:
        - name: "lighthouse"
          password: ""
      tags: [database, clickhouse]

  tasks:
    - name: ‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ ClickHouse
      wait_for:
        host: "127.0.0.1"
        port: "{{ clickhouse_port }}"
        timeout: 30
      tags: [dependencies]

  roles:
    - role: vector
      vector_version: "0.28.0"
      tags: [logging, vector]

  tasks:
    - name: üóÉÔ∏è –°–æ–∑–¥–∞–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –¥–ª—è Lighthouse
      uri:
        url: "http://127.0.0.1:{{ clickhouse_port }}/"
        method: POST
        body: "CREATE DATABASE IF NOT EXISTS lighthouse_metrics"
        status_code: 200
      tags: [database, setup]

  roles:
    - role: lighthouse
      lighthouse_version: "v4.0.1"
      lighthouse_config:
        clickhouse:
          enabled: true
          host: "{{ clickhouse_host }}"
          port: "{{ clickhouse_port }}"
      tags: [monitoring, lighthouse]

  tasks:
    - name: üåê –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
      block:
        - name: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ nginx
          apt:
            name: nginx
            state: present

        - name: –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è nginx –¥–ª—è Lighthouse
          copy:
            dest: /etc/nginx/sites-available/lighthouse
            content: |
              server {
                  listen 80;
                  server_name _;
                  location / {
                      proxy_pass http://127.0.0.1:{{ lighthouse_port }};
                      proxy_set_header Host $host;
                  }
              }

        - name: –ê–∫—Ç–∏–≤–∞—Ü–∏—è —Å–∞–π—Ç–∞
          file:
            src: /etc/nginx/sites-available/lighthouse
            dest: /etc/nginx/sites-enabled/lighthouse
            state: link

        - name: –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ nginx
          systemd:
            name: nginx
            state: restarted
      tags: [web, nginx]

  post_tasks:
    - name: ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏
      block:
        - name: –ü—Ä–æ–≤–µ—Ä–∫–∞ ClickHouse
          uri:
            url: "http://127.0.0.1:{{ clickhouse_port }}/ping"
            status_code: 200
          register: chk_clickhouse

        - name: –ü—Ä–æ–≤–µ—Ä–∫–∞ Lighthouse
          uri:
            url: "http://localhost:{{ lighthouse_port }}/health"
            status_code: 200
            timeout: 10
          register: chk_lighthouse
          ignore_errors: yes

        - name: –û—Ç—á—ë—Ç –æ —Å–æ—Å—Ç–æ—è–Ω–∏–∏
          debug:
            msg: |
              –†–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ:
              - ClickHouse: {{ '‚úì' if chk_clickhouse.status == 200 else '‚úó' }}
              - Lighthouse: {{ '‚úì' if chk_lighthouse is defined and chk_lighthouse.status == 200 else '‚úó' }}
              - –í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å: http://localhost/
      tags: [validation, report]
