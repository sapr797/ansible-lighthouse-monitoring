---
- name: üöÄ Deploy Monitoring Stack (Fixed)
  hosts: localhost
  connection: local
  become: yes

  vars:
    # –û—Ç–∫–ª—é—á–∞–µ–º —É—Å—Ç–∞–Ω–æ–≤–∫—É Vector (–æ–Ω —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω)
    install_vector: false
    clickhouse_port: 8123
    lighthouse_port: 8080

  tasks:
    # 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ ClickHouse
    - name: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã ClickHouse
      uri:
        url: "http://127.0.0.1:{{ clickhouse_port }}/ping"
        status_code: 200
        timeout: 5
      register: clickhouse_check
      ignore_errors: yes

    # 2. –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —É—Å—Ç–∞–Ω–æ–≤–∫—É Vector (—É–∂–µ –µ—Å—Ç—å)
    - name: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ GPG –∫–ª—é—á–∞ Vector
      apt_key:
        url: "https://apt.datadoghq.com/DATADOG_APT_KEY_CURRENT.public"
        state: present
      when: false  # –ü–†–û–ü–£–°–¢–ò–¢–¨ - Vector —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω

    - name: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è Vector
      apt_repository:
        repo: "deb https://packages.timber.io/vector/deb {{ ansible_distribution_release }} main"
        state: present
        filename: "vector"
      when: false  # –ü–†–û–ü–£–°–¢–ò–¢–¨

    - name: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Vector
      apt:
        name: "vector={{ vector_version }}"
        state: present
      when: false  # –ü–†–û–ü–£–°–¢–ò–¢–¨

    # 3. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Lighthouse
    - name: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Lighthouse
      include_role:
        name: lighthouse
      tags: [lighthouse]

    # 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏
    - name: –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏
      debug:
        msg: |
          –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!
          - ClickHouse: {{ '‚úì' if clickhouse_check.status == 200 else '‚úó' }}
          - Vector: ‚úì (—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤—Ä—É—á–Ω—É—é, v0.52.0)
          - Lighthouse: —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ —Ä–æ–ª—å
          
          –ü—Ä–æ–≤–µ—Ä—å—Ç–µ:
          - ClickHouse: http://localhost:8123
          - Vector: vector --version
