---
- name: üéØ –£—Å–ª–æ–≤–Ω–æ–µ —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
  hosts: localhost
  connection: local
  become: yes

  vars:
    deploy_clickhouse: true
    deploy_vector: true  
    deploy_lighthouse: true
    deploy_web: true

    clickhouse_port: 8123
    lighthouse_port: 8080

  tasks:
    - name: üìã –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–ª–∞–Ω–∞ —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏—è
      debug:
        msg: |
          –ü–ª–∞–Ω —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏—è:
          - ClickHouse: {{ deploy_clickhouse }}
          - Vector: {{ deploy_vector }}
          - Lighthouse: {{ deploy_lighthouse }}
          - –í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å: {{ deploy_web }}
      tags: always

  roles:
    - role: clickhouse
      when: deploy_clickhouse
      tags: [clickhouse]

  tasks:
    - name: ‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ ClickHouse (–µ—Å–ª–∏ –Ω—É–∂–µ–Ω Vector/Lighthouse)
      wait_for:
        host: "127.0.0.1"
        port: "{{ clickhouse_port }}"
        timeout: 30
      when: deploy_clickhouse and (deploy_vector or deploy_lighthouse)
      tags: [dependencies]

  roles:
    - role: vector
      when: deploy_vector and deploy_clickhouse
      tags: [vector]

  tasks:
    - name: üóÉÔ∏è –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –ë–î –¥–ª—è Lighthouse
      uri:
        url: "http://127.0.0.1:{{ clickhouse_port }}/"
        method: POST
        body: "CREATE DATABASE IF NOT EXISTS lighthouse_metrics"
        status_code: 200
      when: deploy_lighthouse and deploy_clickhouse
      tags: [database]

  roles:
    - role: lighthouse
      when: deploy_lighthouse and deploy_clickhouse
      tags: [lighthouse]

  tasks:
    - name: üåê –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
      block:
        - name: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ nginx
          apt:
            name: nginx
            state: present
          when: deploy_web

        - name: –ë–∞–∑–æ–≤–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
          copy:
            dest: /etc/nginx/sites-available/lighthouse
            content: |
              server {
                  listen 80;
                  server_name _;
                  location / {
                      proxy_pass http://127.0.0.1:{{ lighthouse_port }};
                  }
              }
          when: deploy_web and deploy_lighthouse

        - name: –ê–∫—Ç–∏–≤–∞—Ü–∏—è –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫
          block:
            - file:
                src: /etc/nginx/sites-available/lighthouse
                dest: /etc/nginx/sites-enabled/lighthouse
                state: link
            - systemd:
                name: nginx
                state: restarted
          when: deploy_web and deploy_lighthouse
      tags: [web]

  post_tasks:
    - name: üìä –ò—Ç–æ–≥–æ–≤—ã–π –æ—Ç—á—ë—Ç
      debug:
        msg: |
          –†–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ. –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:
          {{ '- ClickHouse: ‚úì' if deploy_clickhouse else '- ClickHouse: ‚úó (–ø—Ä–æ–ø—É—â–µ–Ω)' }}
          {{ '- Vector: ‚úì' if deploy_vector and deploy_clickhouse else '- Vector: ‚úó' }}
          {{ '- Lighthouse: ‚úì' if deploy_lighthouse and deploy_clickhouse else '- Lighthouse: ‚úó' }}
          {{ '- –í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å: ‚úì' if deploy_web and deploy_lighthouse else '- –í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å: ‚úó' }}
          
          –î–æ—Å—Ç—É–ø–Ω—ã–µ endpoints:
          {{ '- ClickHouse: http://localhost:8123' if deploy_clickhouse else '' }}
          {{ '- Lighthouse: http://localhost:8080' if deploy_lighthouse else '' }}
          {{ '- –í–µ–±-–ø—Ä–æ–∫—Å–∏: http://localhost/' if deploy_web and deploy_lighthouse else '' }}
      tags: [report]
