---
- name: üöÄ Deploy with Correct Vector Installation
  hosts: localhost
  connection: local
  become: yes

  vars:
    vector_version: "0.28.0"
    lighthouse_port: 8080

  tasks:
    # 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ ClickHouse
    - name: –ü—Ä–æ–≤–µ—Ä–∫–∞ ClickHouse
      uri:
        url: "http://127.0.0.1:8123/ping"
        status_code: 200
        timeout: 5
      register: clickhouse_check
      ignore_errors: yes
      tags: [clickhouse]

    # 2. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Vector –∏–∑ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
    - name: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ GPG –∫–ª—é—á–∞ Timber.io (Vector)
      apt_key:
        url: "https://packages.timber.io/vector/gpg.3543DB2D0A2BC4B8.key"
        state: present
      tags: [vector]

    - name: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è Vector
      apt_repository:
        repo: "deb https://packages.timber.io/vector/deb {{ ansible_distribution_release }} main"
        state: present
        filename: "vector"
      tags: [vector]

    - name: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ apt –∫—ç—à–∞
      apt:
        update_cache: yes
        cache_valid_time: 3600
      tags: [vector]

    - name: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Vector
      apt:
        name: "vector={{ vector_version }}"
        state: present
      tags: [vector]

    # –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —á–µ—Ä–µ–∑ .deb –µ—Å–ª–∏ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
    - name: –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ Vector (.deb)
      block:
        - name: –°–∫–∞—á–∏–≤–∞–Ω–∏–µ Vector .deb
          get_url:
            url: "https://packages.timber.io/vector/{{ vector_version }}/vector-{{ vector_version }}-1.amd64.deb"
            dest: "/tmp/vector-{{ vector_version }}.deb"
            mode: '0644'

        - name: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ .deb –ø–∞–∫–µ—Ç–∞
          apt:
            deb: "/tmp/vector-{{ vector_version }}.deb"
            state: present
      when: false  # –°–Ω–∞—á–∞–ª–∞ –ø–æ–ø—Ä–æ–±—É–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
      tags: [vector, alt]

    # 3. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Lighthouse (–ø—Ä–æ—Å—Ç–∞—è –≤–µ—Ä—Å–∏—è)
    - name: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Lighthouse
      block:
        - name: –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
          file:
            path: /opt/lighthouse
            state: directory

        - name: –°–∫–∞—á–∏–≤–∞–Ω–∏–µ Lighthouse
          get_url:
            url: "https://github.com/sigp/lighthouse/releases/download/v4.0.1/lighthouse-v4.0.1-x86_64-unknown-linux-gnu.tar.gz"
            dest: "/tmp/lighthouse-latest.tar.gz"

        - name: –†–∞—Å–ø–∞–∫–æ–≤–∫–∞
          unarchive:
            src: "/tmp/lighthouse-latest.tar.gz"
            dest: "/opt/lighthouse"
            remote_src: yes

        - name: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–∞–≤
          file:
            path: "/opt/lighthouse/lighthouse"
            mode: '0755'
            owner: root
            group: root

        - name: –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
          copy:
            dest: "/opt/lighthouse/config.toml"
            content: |
              [api]
              address = "0.0.0.0"
              port = {{ lighthouse_port }}
              
              [clickhouse]
              enabled = true
              host = "localhost"
              port = 8123
              database = "lighthouse_metrics"

        - name: –°–æ–∑–¥–∞–Ω–∏–µ systemd —Å–ª—É–∂–±—ã
          copy:
            dest: "/etc/systemd/system/lighthouse.service"
            content: |
              [Unit]
              Description=Lighthouse Monitoring Service
              After=network.target
              
              [Service]
              Type=simple
              User=root
              WorkingDirectory=/opt/lighthouse
              ExecStart=/opt/lighthouse/lighthouse --config /opt/lighthouse/config.toml
              Restart=on-failure
              RestartSec=10
              
              [Install]
              WantedBy=multi-user.target

        - name: –ó–∞–ø—É—Å–∫ Lighthouse
          systemd:
            name: lighthouse
            state: started
            enabled: yes
            daemon_reload: yes
      tags: [lighthouse]

    # 4. –ü—Ä–æ–≤–µ—Ä–∫–∞
    - name: –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏
      block:
        - name: –ü—Ä–æ–≤–µ—Ä–∫–∞ Vector
          command: vector --version
          register: vector_version_check
          ignore_errors: yes
          changed_when: false

        - name: –ü—Ä–æ–≤–µ—Ä–∫–∞ Lighthouse
          wait_for:
            port: "{{ lighthouse_port }}"
            timeout: 30
          ignore_errors: yes

        - name: –§–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç—á—ë—Ç
          debug:
            msg: |
              –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —É—Å—Ç–∞–Ω–æ–≤–∫–∏:
              - ClickHouse: {{ '‚úì –†–∞–±–æ—Ç–∞–µ—Ç' if clickhouse_check is defined and clickhouse_check.status == 200 else '‚úó –û—à–∏–±–∫–∞' }}
              - Vector: {{ '‚úì –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω' if vector_version_check is defined and vector_version_check.rc == 0 else '‚úó –ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω' }}
              - Lighthouse: {{ '‚úì –ó–∞–ø—É—â–µ–Ω' if lighthouse_port is defined else '‚úó –û—à–∏–±–∫–∞' }}
              
              {{ 'Vector –≤–µ—Ä—Å–∏—è: ' + vector_version_check.stdout if vector_version_check is defined and vector_version_check.rc == 0 else '–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Vector –≤—Ä—É—á–Ω—É—é: sudo apt install vector' }}
              
              Endpoints:
              - ClickHouse: http://localhost:8123
              - Lighthouse: http://localhost:{{ lighthouse_port }}
      tags: [report]
