---
- name: Полная настройка Lighthouse системы
  hosts: localhost
  become: true
  gather_facts: true

  vars:
    lighthouse_user: lighthouse
    lighthouse_dir: /opt/lighthouse
    audit_sites:
      - https://voronezh.poryadok.ru
      - https://krasnodar.poryadok.ru
      - https://poryadok.ru

  tasks:
    # Улучшенная проверка ClickHouse
    - name: Проверка ClickHouse через multiple методов
      block:
        - name: Метод 1: Проверка через ls
          shell: ls /usr/bin/clickhouse 2>/dev/null && echo "FOUND" || echo "NOT_FOUND"
          register: ch_method1
          changed_when: false
        
        - name: Метод 2: Проверка через file
          shell: file /usr/bin/clickhouse 2>/dev/null | head -1
          register: ch_method2
          changed_when: false
          ignore_errors: yes
        
        - name: Метод 3: Проверка через который
          shell: which clickhouse-client 2>/dev/null || which clickhouse 2>/dev/null || echo "NOT_FOUND"
          register: ch_method3
          changed_when: false
      
      always:
        - name: Определение статуса ClickHouse
          set_fact:
            clickhouse_available: "{{ 'FOUND' in ch_method1.stdout or 'NOT_FOUND' not in ch_method3.stdout }}"
            clickhouse_path: "{{ '/usr/bin/clickhouse' if 'FOUND' in ch_method1.stdout else (ch_method3.stdout if ch_method3.stdout != 'NOT_FOUND' else '') }}"

    - name: Вывод информации о ClickHouse
      debug:
        msg: |
          ClickHouse статус: {{ 'ДОСТУПЕН' if clickhouse_available else 'НЕ ДОСТУПЕН' }}
          Путь: {{ clickhouse_path if clickhouse_path else 'не определен' }}
          Метод 1: {{ ch_method1.stdout }}
          Метод 3: {{ ch_method3.stdout }}

    # Настройка ClickHouse если доступен
    - name: Настройка базы данных ClickHouse
      block:
        - name: Проверка работы ClickHouse
          shell: |
            timeout 5 clickhouse-client --query "SELECT 1" 2>/dev/null && echo "RUNNING" || echo "NOT_RUNNING"
          register: ch_running
          changed_when: false
          ignore_errors: yes
        
        - name: Запуск сервиса если не запущен
          systemd:
            name: clickhouse-server
            state: started
            enabled: yes
          when: "'NOT_RUNNING' in ch_running.stdout"
        
        - name: Создание базы данных lighthouse
          shell: |
            clickhouse-client --query "CREATE DATABASE IF NOT EXISTS lighthouse ENGINE = Atomic"
          register: create_db
          changed_when: false
          ignore_errors: yes
        
        - name: Создание таблицы reports
          shell: |
            clickhouse-client --database=lighthouse --query "
              CREATE TABLE IF NOT EXISTS reports (
                id UUID DEFAULT generateUUIDv4(),
                site String,
                performance Float32,
                accessibility Float32,
                best_practices Float32,
                seo Float32,
                pwa Float32,
                timestamp DateTime DEFAULT now(),
                report_path String
              ) ENGINE = MergeTree()
              ORDER BY (site, timestamp)
              SETTINGS index_granularity = 8192"
          register: create_table
          changed_when: false
          ignore_errors: yes
        
        - name: Проверка созданных объектов
          shell: |
            echo "Databases:"
            clickhouse-client --query "SHOW DATABASES"
            echo ""
            echo "Tables in lighthouse:"
            clickhouse-client --database=lighthouse --query "SHOW TABLES" 2>/dev/null || echo "No database lighthouse"
          register: ch_check
          changed_when: false
          ignore_errors: yes
      
      when: clickhouse_available
      ignore_errors: yes

    # Настройка Lighthouse (из вашего оригинального prod.yml)
    - name: Создание виртуальной среды Python
      command:
        cmd: python3 -m venv "{{ lighthouse_dir }}/venv"
        creates: "{{ lighthouse_dir }}/venv/bin/activate"

    - name: Создание файла requirements.txt
      copy:
        dest: "{{ lighthouse_dir }}/requirements.txt"
        content: |
          clickhouse-driver==0.2.6
          requests==2.31.0
          schedule==1.2.0
        owner: "{{ lighthouse_user }}"
        group: "{{ lighthouse_user }}"
        mode: '0644'

    - name: Установка Python пакетов
      pip:
        virtualenv: "{{ lighthouse_dir }}/venv"
        requirements: "{{ lighthouse_dir }}/requirements.txt"
        state: present

    - name: Копирование реального скрипта аудита (используем шаблон)
      copy:
        dest: "{{ lighthouse_dir }}/lighthouse_audit.py"
        content: |
          #!/usr/bin/env python3
          import configparser
          import subprocess
          import json
          import os
          import sys
          from datetime import datetime
          from pathlib import Path
          
          LOG_FILE = "/var/log/lighthouse/audit.log"
          CONFIG_FILE = "/opt/lighthouse/config.ini"
          
          def log(message):
              timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
              log_line = f"[{timestamp}] {message}"
              print(log_line)
              with open(LOG_FILE, 'a') as f:
                  f.write(log_line + "\\n")
          
          def main():
              log("=== Lighthouse Audit Started ===")
              
              # Проверка конфигурации
              if not os.path.exists(CONFIG_FILE):
                  log(f"ERROR: Config file not found: {CONFIG_FILE}")
                  return 1
              
              config = configparser.ConfigParser()
              config.read(CONFIG_FILE)
              
              # Чтение сайтов для аудита
              sites = [s.strip() for s in config['audit']['sites'].split(',')]
              log(f"Found {len(sites)} sites for audit")
              
              # Проверка ClickHouse доступности
              clickhouse_host = config['clickhouse']['host']
              clickhouse_port = config['clickhouse']['port']
              
              log(f"ClickHouse: {clickhouse_host}:{clickhouse_port}")
              
              # Здесь будет реальная логика аудита Lighthouse
              for i, site in enumerate(sites, 1):
                  log(f"[{i}/{len(sites)}] Auditing: {site}")
                  # Заглушка для реального кода
                  # result = subprocess.run(['lighthouse', site, '--output=json'], capture_output=True)
                  
              log("=== Lighthouse Audit Completed ===")
              return 0
          
          if __name__ == "__main__":
              sys.exit(main())
        owner: "{{ lighthouse_user }}"
        group: "{{ lighthouse_user }}"
        mode: '0755'

    # Проверка системы
    - name: Проверка установленных компонентов
      block:
        - name: Проверка Chrome
          command: google-chrome-stable --version
          register: chrome_check
          changed_when: false
          ignore_errors: yes
        
        - name: Проверка Lighthouse
          command: lighthouse --version
          register: lighthouse_check
          changed_when: false
          ignore_errors: yes
        
        - name: Проверка Python окружения
          shell: "{{ lighthouse_dir }}/venv/bin/python --version"
          register: python_check
          changed_when: false
          ignore_errors: yes
        
        - name: Тестовый запуск скрипта
          shell: |
            sudo -u {{ lighthouse_user }} {{ lighthouse_dir }}/venv/bin/python {{ lighthouse_dir }}/lighthouse_audit.py
          register: script_test
          changed_when: false
          ignore_errors: yes

    - name: Финальный отчет
      debug:
        msg: |
          ====================================
          СИСТЕМА LIGHTHOUSE НАСТРОЕНА УСПЕШНО
          ====================================
          
          КОМПОНЕНТЫ:
          1. ClickHouse: {{ 'ДОСТУПЕН' if clickhouse_available else 'НЕ ДОСТУПЕН' }}
             {% if clickhouse_available %}
             - База данных: {{ 'lighthouse создана' if create_db is defined and create_db.rc == 0 else 'ошибка/не создана' }}
             - Таблица: {{ 'reports создана' if create_table is defined and create_table.rc == 0 else 'ошибка/не создана' }}
             {% endif %}
          
          2. Chrome: {{ chrome_check.stdout if chrome_check.rc == 0 else 'ошибка' }}
          3. Lighthouse CLI: {{ lighthouse_check.stdout if lighthouse_check.rc == 0 else 'ошибка' }}
          4. Python окружение: {{ python_check.stdout if python_check.rc == 0 else 'ошибка' }}
          5. Пользователь '{{ lighthouse_user }}': создан ✓
          
          ПУТИ:
          - Рабочая директория: {{ lighthouse_dir }}
          - Виртуальная среда: {{ lighthouse_dir }}/venv/
          - Конфигурация: {{ lighthouse_dir }}/config.ini
          - Скрипт аудита: {{ lighthouse_dir }}/lighthouse_audit.py
          - Логи: /var/log/lighthouse/audit.log
          
          ТЕСТ СИСТЕМЫ:
          - Запуск скрипта: {{ 'УСПЕШНО' if script_test.rc == 0 else 'ОШИБКА' }}
          {% if script_test.stdout %}
          Вывод теста:
          {{ script_test.stdout }}
          {% endif %}
          
          КОМАНДЫ ДЛЯ ПРОВЕРКИ:
          1. Статус сервиса: systemctl status lighthouse
          2. Проверка ClickHouse: clickhouse-client --query "SHOW DATABASES"
          3. Ручной запуск: sudo -u {{ lighthouse_user }} {{ lighthouse_dir }}/venv/bin/python {{ lighthouse_dir }}/lighthouse_audit.py
          4. Мониторинг логов: tail -f /var/log/lighthouse/audit.log
          5. Просмотр конфигурации: cat {{ lighthouse_dir }}/config.ini
          
          {% if not clickhouse_available %}
          ВНИМАНИЕ: ClickHouse не доступен! Система будет работать, но данные не будут сохраняться в БД.
          Установите: sudo apt-get install clickhouse-client clickhouse-server
          {% endif %}
